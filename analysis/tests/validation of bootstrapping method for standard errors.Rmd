---
title: "Unconscious EC RRR"
subtitle: "Validation of SE bootstrapping method"
author: "Ian Hussey^[Ghent University. Email: ian.hussey@ugent.be]"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    number_sections: no
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)

# options
options(knitr.table.format = "html") # necessary configuration of tables

# disable scientific notation
options(scipen = 999) 

```

# Dependencies

```{r}

check_for_and_install_packages <- function(package) {
  if (!package %in% installed.packages()) install.packages(package)
}

check_for_and_install_packages("tidyverse")
check_for_and_install_packages("broom")
check_for_and_install_packages("metafor")
check_for_and_install_packages("knitr")
check_for_and_install_packages("kableExtra")
check_for_and_install_packages("rsample")
check_for_and_install_packages("purrr")
check_for_and_install_packages("devtools")
if (!"patchwork" %in% installed.packages()) devtools::install_github("thomasp85/patchwork")

library(tidyverse)
library(broom)
library(metafor)
library(knitr)
library(kableExtra)
library(rsample)
library(purrr)
library(patchwork)

```

# Data

```{r}

# get data
data_processed <- read.csv("data_processed.csv") 

data <- data_processed %>%
  filter(simulated_data == FALSE) %>%  # exclude using the olsen and fazio criteria
  mutate(DV = sum_score_evaluation_CSpos_preferred)

```

# Calculate standard errors for each site via bootstrapping

```{r}

# function to round all numerics in a data frame -----
round_df <- function(df, digits) {
  nums <- vapply(df, is.numeric, FUN.VALUE = logical(1))
  df[,nums] <- round(df[,nums], digits = digits)
  (df)
}

# helper function to apply to each resample to calculate hedges g -----
preferences_effect_size <- function(split){
  
  summary_preferences <- analysis(split) %>%
    group_by(data_collection_site) %>%
    dplyr::summarize(preference_mean = mean(DV),
                     preference_sd = sd(DV),
                     preference_n = n(),
                     preference_cohens_dz = preference_mean/preference_sd,
                     # Hedges' g bias correction formula suggested by Miguel:
                     preference_hedges_g = preference_cohens_dz*(1 - (3/(4*(preference_n-1)-1)))) %>%
    ungroup()
  
  return(summary_preferences)
  
}

nboots = 2000

data %>%
  # create resamples
  group_by(data_collection_site) %>%
  bootstraps(times = nboots) %>%
  # apply to each bootstrap
  mutate(es_boots = map(splits, preferences_effect_size)) %>%
  # unnest
  unnest(es_boots) %>%
  # summarize across resamples
  group_by(data_collection_site) %>%
  summarize(hedges_g        = quantile(preference_hedges_g, 0.500),
            hedges_g_se     = sd(preference_hedges_g),  # nb SEM is SD of the mean 
            hedges_g_ci_lwr = quantile(preference_hedges_g, 0.025),
            hedges_g_ci_upr = quantile(preference_hedges_g, 0.975)) %>%
  ungroup() %>%
  round_df(2) %>%
  pull(hedges_g_se)

```

# Calculate standard errors for each site arithmethically

```{r}

# Miguel's equations:
# J = (1 - (3/(4*preference_n-2)))
# g_var = (J^2) * ( (1 / N) + (d^2 / (2*N)) )
# g_se = sqrt(g_var)

data %>%
  group_by(data_collection_site) %>%
  group_by(data_collection_site) %>%
  dplyr::summarize(preference_mean = mean(DV),
                   preference_sd = sd(DV),
                   preference_n = n(),
                   preference_cohens_dz = preference_mean/preference_sd,
                   # Hedges' g bias correction formula suggested by Miguel:
                   preference_hedges_g = preference_cohens_dz*(1 - (3/(4*(preference_n-1)-1))),
                   J = (1 - (3/(4*preference_n-2))),
                   g_var = (J^2) * ( (1/preference_n) + (preference_cohens_dz^2 / (2*preference_n)) ),
                   g_se = sqrt(g_var)) %>%
  ungroup() %>%
  round_df(2) %>%
  pull(g_se)

```

